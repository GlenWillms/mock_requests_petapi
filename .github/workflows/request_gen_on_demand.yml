name: Trigger Curl Requests with JWT Token and Conditional Authorization

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  curl_requests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Read and trigger curl requests from endpoints.txt with methods, POST/PUT body, and JWT token
      run: |
        token=""
        while IFS='' read -r method url body; do
          timestamp=$(TZ="America/Los_Angeles" date "+%H:%M:%S")

          # Encode the URL to handle spaces
          url_encoded=$(echo "$url" | jq -sRr @uri)

          # Check if URL ends with /jwt
          if [[ "$url" == */JWT ]]; then
            echo "[$timestamp PST] $method to $url : Capturing JWT"
            response=$(curl -s -X "$method" "$url_encoded" -H "Content-Type: application/json" -d "$body")
            token=$(echo "$response" | jq -r '.token')  # Extract the token value from the response
            echo "[$timestamp PST] $method to $url : $response_code + token"
            continue
          fi

          # Prepare the curl command for /Submit/ endpoints
          if [[ "$url" == */Update ]] && [[ "$method" == "POST" || "$method" == "PUT" ]]; then
            response_code=$(curl -o /dev/null -s -w "%{http_code}" -X "$method" "$url_encoded" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $token" -d "$body")
            echo "[$timestamp PST] $method to $url : $response_code"
          else
            # For all other methods
            if [[ "$method" == "POST" || "$method" == "PUT" ]]; then
              response_code=$(curl -o /dev/null -s -w "%{http_code}" -X "$method" "$url_encoded" \
                -H "Content-Type: application/json" -d "$body")
            else
              response_code=$(curl -o /dev/null -s -w "%{http_code}" -X "$method" "$url_encoded")
            fi
            echo "[$timestamp PST] $method to $url : $response_code"
          fi

          sleep 1  # Delay of 1 second
        done < endpoints.txt
